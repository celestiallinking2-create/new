{% extends "base.html" %}

{% block title %}Problem Solver - Celestial Linking{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="text-center mb-5">
        <h1 class="display-5 fw-bold">
            <i class="bi bi-calculator"></i> Problem Solver
        </h1>
        <p class="lead text-muted">View all your solved quantum physics problems</p>
    </div>

    {% if not user or not user.is_authenticated %}
    <div class="alert alert-info text-center">
        <i class="bi bi-info-circle"></i>
        <a href="{{ url_for('replit_auth.login') }}">Sign in</a> to save and view your solved problems permanently.
        <br>
        <small>Session problems are available in <a href="{{ url_for('runs') }}">Runs & Results</a></small>
    </div>
    {% endif %}

    {% if problems %}
    <div class="row g-4">
        {% for problem in problems %}
        <div class="col-md-6 col-lg-4">
            <div class="problem-card h-100">
                <div class="problem-card-header">
                    <h5>{{ problem.equation_name }}</h5>
                    <small class="text-muted">{{ problem.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                </div>
                <div class="problem-card-body">
                    <div class="parameters-list mb-3">
                        <strong>Parameters:</strong>
                        {% set params = problem.get_parameters() %}
                        <ul class="list-unstyled small">
                            {% for key, value in params.items() %}
                            <li>{{ key }}: {{ value }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    <div class="solution-preview">
                        <strong>Key Results:</strong>
                        {% set solution = problem.get_solution() %}
                        <ul class="list-unstyled small">
                            {% for key, value in solution.items() %}
                            {% if loop.index <= 3 %}
                            <li>{{ key.replace('_', ' ').title() }}: 
                                {% if value is number %}
                                {{ "%.4e"|format(value) if value|abs < 0.001 or value|abs > 10000 else "%.4f"|format(value) }}
                                {% else %}
                                {{ value }}
                                {% endif %}
                            </li>
                            {% endif %}
                            {% endfor %}
                        </ul>
                    </div>
                </div>
                <div class="problem-card-footer">
                    <button class="btn btn-sm btn-primary view-problem-btn" data-id="{{ problem.id }}">
                        <i class="bi bi-eye"></i> View Details
                    </button>
                    <div class="btn-group">
                        <a href="{{ url_for('export_graph', problem_id=problem.id) }}" class="btn btn-sm btn-outline-success">
                            <i class="bi bi-image"></i>
                        </a>
                        <a href="{{ url_for('export_excel', problem_id=problem.id) }}" class="btn btn-sm btn-outline-info">
                            <i class="bi bi-file-excel"></i>
                        </a>
                        <button class="btn btn-sm btn-outline-danger delete-problem-btn" data-id="{{ problem.id }}">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-5">
        <i class="bi bi-inbox" style="font-size: 4rem; color: var(--accent-secondary);"></i>
        <h4 class="mt-3">No Solved Problems Yet</h4>
        <p class="text-muted">Start solving quantum physics problems from the library!</p>
        <a href="{{ url_for('library') }}" class="btn btn-primary">
            <i class="bi bi-book"></i> Go to Library
        </a>
    </div>
    {% endif %}
</div>

<div class="modal fade" id="problemModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="problemModalTitle">Problem Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-lg-6">
                        <div id="modalGraphContainer" class="graph-container mb-3">
                            <img id="modalGraphImage" src="" alt="Graph" class="img-fluid">
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div id="modalSolution" class="solution-data mb-3"></div>
                        <div id="modalSteps" class="steps-container"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.querySelectorAll('.view-problem-btn').forEach(btn => {
    btn.addEventListener('click', async function() {
        const problemId = this.dataset.id;
        const response = await fetch(`/api/problem/${problemId}`);
        const data = await response.json();
        
        if (data.error) {
            alert(data.error);
            return;
        }

        document.getElementById('problemModalTitle').textContent = data.equation_name;
        
        if (data.graph) {
            document.getElementById('modalGraphImage').src = 'data:image/png;base64,' + data.graph;
        }

        const solutionHtml = Object.entries(data.solution).map(([key, value]) => {
            const formattedKey = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            const formattedValue = typeof value === 'number' ? 
                (Math.abs(value) < 0.001 || Math.abs(value) > 10000 ? value.toExponential(4) : value.toFixed(6)) : 
                value;
            return `<div class="solution-item">
                <span class="solution-key">${formattedKey}:</span>
                <span class="solution-value">${formattedValue}</span>
            </div>`;
        }).join('');
        document.getElementById('modalSolution').innerHTML = solutionHtml;

        const stepsHtml = data.steps.map((step, index) => 
            `<div class="step-item">
                <span class="step-number">${index + 1}</span>
                <span class="step-text">${step}</span>
            </div>`
        ).join('');
        document.getElementById('modalSteps').innerHTML = stepsHtml;

        new bootstrap.Modal(document.getElementById('problemModal')).show();
    });
});

document.querySelectorAll('.delete-problem-btn').forEach(btn => {
    btn.addEventListener('click', async function() {
        if (!confirm('Are you sure you want to delete this problem?')) return;
        
        const problemId = this.dataset.id;
        const response = await fetch(`/api/delete_problem/${problemId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            location.reload();
        } else {
            alert('Failed to delete problem');
        }
    });
});
</script>
{% endblock %}
